# 用例与场景_V2.3

> 版本更新记录（2025-01-21）：新增多智能体研究报告自动化用例（UC-MA-001），对齐七天滚动计划的首个演示场景。

## 新增用例：多智能体研究报告自动化（UC-MA-001）

### 用例概述
**用例编号**：UC-MA-001  
**用例名称**：多智能体研究报告自动化  
**优先级**：高  
**复杂度**：高  
**所属模块**：多智能体系统（星河Orchestrator v0）

### 参与角色
- **主要用户**：研究员、产品经理、技术负责人
- **系统角色**：
  - LeadResearcher：主指挥，负责任务分解与结果整合
  - SearchAgent：并行搜索，负责多源信息检索
  - SynthesisAgent：内容合成，负责结构化报告生成
  - CitationAgent：引用管理，负责可信度评估与格式化

### 前置条件
- 用户具备有效的系统访问权限
- 多智能体系统已完成初始化（LeadResearcher + 3个子智能体已就绪）
- 系统预算池不少于100 tokens/requests
- 目标研究主题明确且边界清晰

### 主成功场景
1. **任务接收与分解**
   - 用户通过 `/api/v2.3-preview/agents/run` 提交研究请求
   - 请求体包含：`task_type: "research_report"`、`query`、`max_agents: 4`、`budget: 1000`、`quality_threshold: 0.85`
   - LeadResearcher接收任务，执行Interleaved thinking循环
   - 将研究主题分解为3-5个并行搜索子任务

2. **并行信息检索**
   - SearchAgent-1: 学术论文与技术报告检索
   - SearchAgent-2: 行业动态与商业案例分析
   - SearchAgent-3: 开源项目与实现方案调研
   - 每个SearchAgent独立执行，结果存入共享记忆池
   - 实时监控预算消耗与质量门禁

3. **内容合成与整合**
   - SynthesisAgent接收所有搜索结果
   - 执行结构化报告生成：
     - 执行摘要（Executive Summary）
     - 技术现状分析（Current State Analysis）
     - 关键发现与洞察（Key Findings & Insights）
     - 建议与下一步行动（Recommendations & Next Steps）
   - 确保内容逻辑连贯性与完整性

4. **引用管理与质量保证**
   - CitationAgent对所有引用进行可信度评估
   - 按学术标准格式化引用（IEEE/APA格式可选）
   - 生成引用可信度评分（0.0-1.0）
   - 标记低可信度引用并建议替代来源

5. **结果交付与反馈**
   - LeadResearcher整合最终报告
   - 返回结构化响应：`report_content`、`citations`、`quality_score`、`budget_used`、`execution_trace`
   - 用户可通过 `trace_id` 查询详细执行过程

### 异常场景
- **E1-预算耗尽**：系统自动降级为单智能体模式，返回部分结果
- **E2-质量门禁失败**：自动重试最多2次，若仍失败则返回错误码4001
- **E3-搜索无结果**：LeadResearcher自动调整搜索策略或扩大范围
- **E4-Agent超时**：单个Agent超时后自动切换为备用策略
- **E5-引用冲突**：CitationAgent启用冲突解决算法，选择最高可信度源

### 后置条件
- 生成完整的结构化研究报告（≥2000字）
- 包含不少于10个有效引用（可信度≥0.7）
- 执行轨迹已记录至系统日志
- 预算消耗记录已更新
- 用户满意度评分机制已触发

### 性能要求
- **端到端完成时间**：P95 < 300秒，P99 < 600秒
- **并行度**：支持最多4个Agent同时工作
- **内存占用**：单次任务峰值内存≤2GB
- **预算效率**：平均每1000 tokens生成≥500字有效内容

### 质量门禁
- **内容质量**：结构完整性≥90%，逻辑连贯性≥85%
- **引用质量**：引用准确性≥95%，可信度平均分≥0.8
- **时效性**：信息新鲜度≤6个月（可配置）
- **原创性**：内容重复度≤15%

### 测试用例示例
```json
{
  "task_type": "research_report",
  "query": "Anthropic多智能体系统的工程实践与Claude团队的架构选择分析",
  "constraints": [
    "侧重技术实现细节",
    "包含开源对比分析",
    "提供可落地建议"
  ],
  "max_agents": 4,
  "budget": 1000,
  "quality_threshold": 0.85,
  "output_format": "structured_markdown",
  "citation_style": "ieee"
}
```

### 验收标准
1. **功能验收**：
   - [ ] 能够正确解析研究请求并分解任务
   - [ ] 4个Agent能够并行工作且无冲突
   - [ ] 生成的报告结构完整且内容充实
   - [ ] 引用格式正确且可信度评分准确

2. **性能验收**：
   - [ ] 响应时间符合SLA要求
   - [ ] 内存占用在合理范围内
   - [ ] 预算使用高效且可控

3. **质量验收**：
   - [ ] 内容原创性检查通过
   - [ ] 引用可信度评估准确
   - [ ] 用户满意度≥4.0/5.0

### 风险识别与缓解
- **风险R1**：Agent间协调复杂度高
  - **缓解**：实施标准化的Agent间通信协议
- **风险R2**：引用源可靠性验证困难
  - **缓解**：建立可信来源白名单与评分算法
- **风险R3**：内容生成质量不稳定
  - **缺解**：引入多轮质量检查与人工审核选项

> 更新公告（2025-08-22）
> - 新增用例族：CE-UC（云端授权/同步/撤销/导出）、EMO-UC（熙龙同行册浏览/写入/引用）。
> - 验收要点：所有"改动"均支持预览→确认→可回滚；云端操作需双重确认与审计。

> v0.2 补充（2025-08-21）
> - 完成 UC-CE-001/002/003、UC-EMO-001/002 的主/备流程与异常处理细化。
> - 明确验收标准、业务规则、SLA 阈值，支持设计开发与测试。

- 版本：V2.3
- 文档状态：v0.2（初版完成）
- 作者：星河
- 审批：熙龙（待审批）
- 最近修订：2025-08-21

## 1. 用例总览

| 用例编号 | 用例名称 | 触发角色 | 优先级 | 所属模块 | 关联需求 |
|---------|----------|----------|--------|----------|----------|
| UC-CE-001 | 云端授权管理 | 用户 | P0 | CE | REQ-CE-001 |
| UC-CE-002 | 数据采集与匿名化 | 系统 | P0 | CE | REQ-CE-002 |
| UC-CE-003 | 端云记忆同步 | 系统/用户 | P1 | CE | REQ-CE-003 |
| UC-CE-004 | 数据导出与删除 | 用户 | P1 | CE | REQ-CE-004 |
| UC-EMO-001 | 叙事条目管理 | 用户 | P0 | EMO | REQ-EMO-001 |
| UC-EMO-002 | 情感标签与关联 | 系统/用户 | P1 | EMO | REQ-EMO-002 |

## 2. 关键场景流程

### 2.1 核心场景：用户首次开启云端学习
```
[用户] → [授权确认页面] → [数据最小化选择] → [双重确认] → [开始匿名化同步] → [状态可视化]
  ↓              ↓                ↓            ↓              ↓                ↓
 撤销          预览采集内容     选择数据类型   确认风险      后台同步job        实时监控
```

### 2.2 异常场景：云端服务不可用时降级
```
[同步请求] → [云端超时] → [自动降级] → [本地模式] → [恢复检测] → [增量同步]
     ↓           ↓          ↓          ↓          ↓          ↓
   正常路径    重试3次    用户提示    离线工作   定期检查   差异合并
```

## 3. 用例详细规格

---

### UC-CE-001: 云端授权管理

**基本信息**
- 编号：UC-CE-001
- 名称：云端授权管理
- 触发者：用户
- 前置条件：用户已登录系统，具备云端学习功能权限
- 后置条件：授权状态已确认并记录审计日志

**主流程**
1. 用户进入"云端学习设置"页面
2. 系统显示当前授权状态（未授权/已授权/已撤销）
3. 如选择"开启云端学习"：
   - 3.1 系统展示数据采集清单与隐私声明
   - 3.2 用户确认数据类型范围（对话记录/文档内容/使用习惯）
   - 3.3 用户阅读风险提示并进行双重确认（勾选+密码/生物验证）
   - 3.4 系统创建 Consent 记录，状态设为 active
   - 3.5 系统显示授权成功，预计同步时间
4. 如选择"撤销授权"：
   - 4.1 系统展示当前已同步数据概览
   - 4.2 用户确认撤销并选择数据处理方式（保留/删除）
   - 4.3 用户进行安全验证
   - 4.4 系统将 Consent.status 更新为 revoked
   - 4.5 触发云端数据删除流程（如用户选择删除）

**备选流程**
- A1: 用户在步骤3.3取消确认 → 返回设置页面，不创建授权记录
- A2: 双重确认失败（3次） → 系统锁定功能30分钟，记录异常日志
- A3: 撤销过程中网络异常 → 本地标记为pending_revoke，后台重试

**异常流程**
- E1: 云端服务不可用 → 显示"暂时无法连接云端，请稍后重试"
- E2: 数据库写入失败 → 回滚操作，显示错误信息
- E3: 用户权限不足 → 跳转权限申请页面

**业务规则**
- BR1: 单用户最多只能有1个 active 状态的 Consent
- BR2: 撤销操作必须记录具体原因（用户输入或系统选项）
- BR3: 授权有效期默认1年，到期前30天提醒续期
- BR4: 敏感操作（撤销/续期）需要重新身份验证

**验收标准**
- AC1: 授权页面响应时间≤500ms（P95）
- AC2: 双重确认流程完整，验证失败有明确提示
- AC3: 撤销操作RTO≤5分钟，云端数据删除RTO≤24小时
- AC4: 所有状态变更记录审计日志，包含时间戳、用户ID、操作类型

---

### UC-CE-002: 数据采集与匿名化

**基本信息**
- 编号：UC-CE-002
- 名称：数据采集与匿名化
- 触发者：系统（基于用户授权和数据变化事件）
- 前置条件：用户已授权云端学习，系统检测到可采集数据
- 后置条件：数据已匿名化并加入同步队列，采集记录可审计

**主流程**
1. 系统检测到数据变化事件（对话/文档编辑/配置修改）
2. 检查用户当前授权状态（Consent.status = active）
3. 根据授权范围判断是否需要采集该数据类型
4. 执行敏感信息检测：
   - 4.1 身份信息（姓名/身份证/手机/邮箱/地址）
   - 4.2 密钥信息（API Key/密码/Token/证书）
   - 4.3 生物特征（指纹/人脸/声纹数据）
5. 对检测到的敏感信息进行处理：
   - 5.1 高敏感：直接删除或替换为占位符
   - 5.2 中敏感：哈希化或差分隐私处理
   - 5.3 低敏感：可选脱敏（如部分字符掩码）
6. 生成采集记录（时间戳、数据类型、处理方式、内容摘要）
7. 将匿名化数据加入 StudyQueue，等待同步

**备选流程**
- A1: 敏感信息检测误报 → 记录 false positive，更新检测模型
- A2: 用户临时暂停采集 → 跳过当前数据，记录暂停原因
- A3: 匿名化处理失败 → 丢弃原始数据，记录失败日志

**异常流程**
- E1: 敏感信息检测服务不可用 → 采用保守策略，跳过该数据
- E2: 匿名化算法异常 → 停止采集，发送告警
- E3: StudyQueue 满载 → 根据优先级丢弃低价值数据

**业务规则**
- BR1: 敏感信息检测准确率≥99.5%，误报率≤0.1%
- BR2: 匿名化后数据不得逆向还原为原始内容
- BR3: 采集频率限制：单用户每分钟≤100条记录
- BR4: 数据保留期：匿名化数据最长保留2年

**验收标准**
- AC1: 敏感信息检测响应时间≤200ms（P95）
- AC2: 匿名化处理成功率≥99.8%
- AC3: 采集日志完整性校验（SHA-256哈希）
- AC4: 支持采集记录可视化查询（按时间/类型/处理方式）

---

### UC-CE-003: 端云记忆同步

**基本信息**
- 编号：UC-CE-003
- 名称：端云记忆同步
- 触发者：系统（定时调度）+ 用户（手动触发）
- 前置条件：存在待同步数据，云端服务可用，用户授权有效
- 后置条件：本地与云端记忆状态一致，冲突已解决

**主流程**
1. CloudSyncJob 调度器检测到同步条件：
   - 1.1 定时触发（每30分钟）
   - 1.2 手动触发（用户点击"立即同步"）
   - 1.3 数据积累触发（待同步数据>100条）
2. 创建 CloudSyncJob 记录，状态设为 pending
3. 执行增量同步：
   - 3.1 获取本地最新 memory checksum
   - 3.2 向云端请求 diff（基于 checksum）
   - 3.3 下载云端新增/修改的记忆条目
   - 3.4 上传本地新增/修改的匿名化数据
4. 冲突检测与解决：
   - 4.1 同一记忆条目的版本冲突：选择最新时间戳版本
   - 4.2 语义冲突（相同问题不同答案）：保留双份，标记为 conflict
   - 4.3 依赖冲突（引用链断裂）：自动修复或标记为 orphaned
5. 验证同步结果：
   - 5.1 计算本地与云端 checksum 一致性
   - 5.2 抽样验证10%数据内容一致性
   - 5.3 更新 CloudSyncJob.status 为 completed
 6. 触发本地索引重建（如有数据变更）

**备选流程**
- A1: 网络质量差 → 分批同步，单批≤10MB
- A2: 云端版本过旧 → 强制全量同步
- A3: 用户在同步过程中撤销授权 → 立即停止上传，完成下载

**异常流程**
- E1: 同步超时(>5分钟) → 标记为 timeout，重试
- E2: 冲突无法自动解决 → 状态设为 manual_required，通知用户
- E3: 数据完整性校验失败 → 回滚本地变更，记录错误

**业务规则**
- BR1: 同步成功率≥99.0%（7天滚动窗口）
- BR2: 单次同步时间≤3分钟（P95）
- BR3: 冲突自动解决率≥90%
- BR4: 支持离线模式，联网后自动增量同步

**验收标准**
- AC1: 端到端同步延迟≤1.5s（P95）
- AC2: 数据一致性验证通过率100%
- AC3: 冲突解决算法覆盖5种以上场景
- AC4: 支持同步进度可视化与任务中断恢复

---

### UC-EMO-001: 叙事条目管理

**基本信息**
- 编号：UC-EMO-001
- 名称：叙事条目管理（熙龙同行册）
- 触发者：用户
- 前置条件：用户已进入叙事记忆册功能模块
- 后置条件：叙事条目已保存，支持检索与关联分析

**主流程**
1. 用户进入"熙龙同行册"界面
2. 选择操作类型：
   - 2.1 创建新条目
   - 2.2 编辑现有条目  
   - 2.3 删除条目
   - 2.4 查询检索
3. 如选择"创建新条目"：
   - 3.1 用户输入标题（≤200字符）
   - 3.2 用户编辑正文内容（支持 Markdown）
   - 3.3 系统自动分析情感倾向（喜悦/悲伤/愤怒/恐惧/中性）
   - 3.4 用户确认或调整情感标签
   - 3.5 系统提取关键词并推荐关联条目
   - 3.6 用户选择关联链接（可选）
   - 3.7 保存 NarrativeEntry 记录
4. 如选择"查询检索"：
   - 4.1 用户输入关键词或选择标签筛选
   - 4.2 系统执行全文检索 + 语义相似度匹配
   - 4.3 返回结果按相关度排序
   - 4.4 支持预览与跳转详情

**备选流程**
- A1: 内容过长(>10000字符) → 提示分段或摘要
- A2: 情感分析结果不准确 → 用户手动标记，更新模型
- A3: 关联推荐无结果 → 跳过关联步骤

**异常流程**
- E1: 内容保存失败 → 本地缓存草稿，提示重试
- E2: 情感分析服务异常 → 跳过自动标签，允许手动标记
- E3: 检索服务响应超时 → 降级为简单关键词匹配

**业务规则**
- BR1: 单用户最多创建10,000条叙事条目
- BR2: 条目内容默认仅本地存储，云端同步需独立授权
- BR3: 删除操作支持30天内恢复（软删除）
- BR4: 情感标签支持多选，最多3个主要情感

**验收标准**
- AC1: 条目创建响应时间≤2s（P95）
- AC2: 情感分析准确率≥85%（基于用户反馈调整）
- AC3: 全文检索召回率≥95%，精确率≥90%
- AC4: 关联推荐召回率≥70%（基于用户接受率）

---

### UC-EMO-002: 情感标签与引用链

**基本信息**
- 编号：UC-EMO-002
- 名称：情感标签与引用链分析
- 触发者：系统（内容分析）+ 用户（手动操作）
- 前置条件：存在叙事条目内容，NLP分析服务可用
- 后置条件：条目已完成情感标记与引用链建立

**主流程**
1. 系统接收到叙事条目（新建或编辑）
2. 执行情感分析：
   - 2.1 文本预处理（去停用词、分词、语法分析）
   - 2.2 情感分类：基于预训练模型识别主要情感
   - 2.3 情感强度评分：0.0-1.0 表示情感强烈程度
   - 2.4 生成情感标签建议
3. 执行引用链分析：
   - 3.1 实体识别：项目/需求/设计/测试相关名词
   - 3.2 语义匹配：与现有工程文档计算相似度
   - 3.3 关联度评分：0.0-1.0 表示关联强度
   - 3.4 生成引用链建议
4. 用户确认与调整：
   - 4.1 展示情感标签建议，用户可增删改
   - 4.2 展示引用链建议，用户可选择接受/拒绝
   - 4.3 支持手动添加自定义标签与链接
5. 保存结果：
   - 5.1 更新 NarrativeEntry.emotion_tags
   - 5.2 创建 MemoryLink 关联记录
   - 5.3 更新全局标签词典与引用图谱

**备选流程**
- A1: 情感分析置信度低(<0.6) → 仅提供建议，不自动应用
- A2: 引用链匹配无结果 → 记录为独立条目
- A3: 用户拒绝所有建议 → 保存为纯文本条目

**异常流程**
- E1: NLP服务不可用 → 跳过自动分析，支持手动标记
- E2: 引用链循环依赖 → 自动断环，记录警告
- E3: 标签词典更新失败 → 本地缓存，稍后同步

**业务规则**
- BR1: 情感标签自动化率≥80%，人工干预率≤20%
- BR2: 引用链深度≤5层，避免过度关联
- BR3: 标签词典定期清理（删除使用频率<0.1%的标签）
- BR4: 引用链支持双向查询（A→B, B→A）

**验收标准**
- AC1: 情感分析响应时间≤1s（P95）
- AC2: 引用链完整性≥95%（无断链/死链）
- AC3: 标签推荐接受率≥70%（基于用户操作统计）
- AC4: 检索性能：按标签筛选响应时间≤500ms

## 4. 验收与度量

### 4.1 功能验收指标
- 用例通过率：100%（核心路径）
- 端到端测试覆盖率：≥95%
- 用户接受度测试：满意度≥4.0/5.0

### 4.2 性能验收指标
- 响应时间：所有交互操作P95≤2s
- 吞吐能力：支持100并发用户无性能衰减
- 可用性：月度SLO≥99.0%

### 4.3 安全与合规验收
- 隐私扫描：0高危问题
- 权限测试：未授权访问拦截率100%
- 审计完整性：所有敏感操作可追溯

## 5. 变更记录
- 2025-08-20：创建初稿骨架（星河）
- 2025-08-21：v0.2细化 - 补全6个核心用例规格，明确验收标准（星河）

## 6. 附录
- 用例模板：遵循IEEE 29148标准
- 流程图命名：UC_{模块}_{编号}_{版本}_{日期}.svg
- 关联文档：《需求规格说明书_V2.3》、《接口需求清单_V2.3》