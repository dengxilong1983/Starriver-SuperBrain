# 领域模型与数据字典_V2.3

> 更新公告（2025-08-22）
> - 新增 Consent、CloudSyncJob、NarrativeEntry 等实体占位。

> v0.2 补充（2025-08-21）
> - 补全核心实体字段、枚举、约束与关系；给出文本版 ER 与关键业务规则。

- 版本：V2.3
- 文档状态：v0.2（初版完成）
- 作者：星河
- 审批：熙龙（待审批）
- 最近修订：2025-08-21

## 1. 核心实体与字段

### 1.1 Consent（授权）
- id: uuid（PK）
- userId: uuid（FK → User.id）
- status: enum ConsentStatus = [active, revoked, pending]
- scope.dataTypes: DataType[] = [dialog, document, usage]
- reason: string（枚举：user_initiated/expired/policy_update/other）
- expiresAt: datetime（UTC，可为空）
- createdAt: datetime（UTC）
- updatedAt: datetime（UTC）
- revokeReason: string（可空）
- revokeAt: datetime（UTC，可空）

约束与索引：
- UQ(userId, status=active) 保证单用户仅 1 个 active
- IDX(userId)

### 1.2 CloudSyncJob（同步/导出作业）
- id: uuid（PK）
- userId: uuid（FK → User.id）
- type: enum JobType = [full, incremental, export]
- status: enum JobStatus = [pending, in_progress, completed, failed, timeout, manual_required]
- checksumBefore: string（sha256，可空）
- checksumAfter: string（sha256，可空）
- stats: json { uploaded: int, downloaded: int, conflicts: int, retries: int }
- startedAt: datetime（UTC）
- finishedAt: datetime（UTC，可空）
- errorCode: string（可空）
- errorMsg: string（可空）

索引：
- IDX(userId, startedAt desc)
- IDX(status)

### 1.3 NarrativeEntry（叙事条目）
- id: uuid（PK）
- userId: uuid（FK → User.id）
- title: string(200)
- contentMd: text
- emotionTags: EmotionTag[]（多值）
- keywords: string[]
- visibility: enum Visibility = [local, cloud]
- linksCount: int（冗余计数）
- createdAt: datetime（UTC）
- updatedAt: datetime（UTC）
- deletedAt: datetime（UTC，可空，软删除）

索引：
- FULLTEXT(contentMd, title)（若底层支持）
- IDX(userId, createdAt desc)

### 1.4 StudyQueue（采集队列项）
- id: uuid（PK）
- userId: uuid（FK → User.id）
- itemType: enum ItemType = [memory, narrative, link]
- refId: uuid（引用对应实体）
- priority: int（0-9，默认 5）
- state: enum QueueState = [queued, processing, failed, done, skipped]
- attempts: int（重试次数）
- lastError: string（可空）
- createdAt: datetime（UTC）
- updatedAt: datetime（UTC）

索引：
- IDX(userId, state)
- IDX(priority desc, createdAt)

### 1.5 MemoryLink（引用关系）
- id: uuid（PK）
- fromType: enum ItemType
- fromId: uuid
- toType: enum ItemType
- toId: uuid
- relation: enum RelationType = [references, derives, duplicates, mentions]
- weight: float（0.0-1.0）
- createdAt: datetime（UTC）

约束：
- UQ(fromType, fromId, toType, toId, relation)
- 方向可逆视图支持（便于 A→B 与 B→A 查询）

### 1.6 AgentTask（多智能体任务）
- id: uuid（PK）
- userId: uuid（FK → User.id）
- taskType: enum AgentTaskType = [research_report, quick_answer, code_refactor]
- query: text
- status: enum AgentTaskStatus = [pending, in_progress, completed, failed, canceled, timeout]
- budgetTokens: int（≥0，默认 0）
- budgetSeconds: int（≥0，默认 0）
- maxAgents: int（1-10，预览期建议≤5）
- qualityThreshold: float（0.0-1.0，默认 0.8）
- createdAt: datetime（UTC）
- updatedAt: datetime（UTC）

索引：
- IDX(userId, createdAt desc)
- IDX(status, createdAt desc)

约束：
- CK(budgetTokens ≥ 0 and budgetSeconds ≥ 0)
- CK(qualityThreshold between 0 and 1)
- CK(maxAgents between 1 and 10)

### 1.7 AgentTrace（执行轨迹）
- id: uuid（PK）
- taskId: uuid（FK → AgentTask.id）
- events: json（步骤/工具调用/思考片段，JSONL 或数组）
- citations: json（来源列表：url/title/doi/hash 等）
- metrics: json（latency_ms/cost_tokens/agent_counts 等）
- sizeBytes: int（≤5MB 预览期）
- createdAt: datetime（UTC）

索引：
- IDX(taskId)

### 1.8 AgentConfig（Agent 配置）
- id: uuid（PK）
- name: string(100)
- agentType: enum AgentType = [lead_researcher, search, synthesis, citation]
- params: json（temperature/top_k/tools 等）
- enabled: boolean（默认 true）
- version: string(32)
- createdAt: datetime（UTC）
- updatedAt: datetime（UTC）

索引：
- UQ(name, version)
- IDX(agentType)

### 1.9 AgentWorker（工作器心跳）
- id: uuid（PK）
- workerId: string(64)
- agentType: enum AgentType
- status: enum WorkerStatus = [idle, busy, unhealthy, draining]
- capacity: int（并发能力）
- lastHeartbeatAt: datetime（UTC）
- currentTaskId: uuid（FK → AgentTask.id，可空）

索引：
- IDX(status)
- IDX(agentType)

## 2. 枚举定义
- ConsentStatus: active, revoked, pending
- DataType: dialog, document, usage
- JobType: full, incremental, export
- JobStatus: pending, in_progress, completed, failed, timeout, manual_required
- ItemType: memory, narrative, link
- QueueState: queued, processing, failed, done, skipped
- RelationType: references, derives, duplicates, mentions
- Visibility: local, cloud
- EmotionTag: joy, sadness, anger, fear, neutral（可扩展）
- AgentTaskType: research_report, quick_answer, code_refactor
- AgentTaskStatus: pending, in_progress, completed, failed, canceled, timeout
- AgentType: lead_researcher, search, synthesis, citation
- WorkerStatus: idle, busy, unhealthy, draining

## 3. 关系与边界
- User 1..* Consent（active≤1）
- User 1..* NarrativeEntry
- NarrativeEntry *..* NarrativeEntry（通过 MemoryLink 形成引用图）
- User 1..* CloudSyncJob
- StudyQueue → 引用 Memory/Narrative/Link 作为待处理项
- User 1..* AgentTask
- AgentTask 1..* AgentTrace
- AgentConfig 多实例（系统级/租户级），AgentWorker 为运行时实体

边界说明：
- StudyQueue 不持久化原始敏感内容，只存引用与摘要
- 任何“云端撤销”将阻断 StudyQueue 的新入队，并清理云端导出缓存
- AgentTrace 可开启脱敏与抽样；默认保留 7 天或≤5MB，二者取小
- 预览期多智能体 maxAgents ≤ 5，超限自动降级为单智能体

## 4. 文本版 ER 图（逻辑）
```
[User] 1---* [Consent]
[User] 1---* [CloudSyncJob]
[User] 1---* [NarrativeEntry]
[NarrativeEntry] *---* [NarrativeEntry] via [MemoryLink]
[StudyQueue] -> (memory|narrative|link by refId)
```

## 5. 业务规则与约束
- BR-Consent-01：同一 userId 同时仅允许 1 条 active 记录
- BR-Consent-02：revoke 需要记录 revokeReason 与 revokeAt
- BR-Sync-01：CloudSyncJob 超时阈值 5 分钟，超时标记 timeout 并可重试
- BR-Queue-01：StudyQueue 单用户每分钟入队 ≤ 100 条；队列深度>80% 时丢弃低优先级项
- BR-Narr-01：NarrativeEntry 软删除后 30 天内可恢复
- BR-AGT-01：AgentTask.budgetSeconds 为墙钟时间上限；执行超限→status=timeout
- BR-AGT-02：AgentTask.qualityThreshold 默认 0.8，取值 [0.0,1.0]；为空时取默认
- BR-AGT-03：AgentTask 状态流转：pending→in_progress→{completed|failed|timeout|canceled}；禁止其他逆向流转
- BR-AGT-04：预览期 maxAgents ≤ 5；>5 则拒绝或自动降级
- BR-AGT-05：AgentTrace.sizeBytes ≤ 5MB；超限需截断并标记 metrics.trace_truncated=true
- BR-AGT-06：取消（cancel）幂等；重复取消不改变最终状态

## 6. 字段约定与校验
- 所有时间字段均为 UTC ISO8601；id 使用 UUIDv4
- 文本字段默认 UTF-8；contentMd 最大 10000 字符（超出需分段）

## 7. 变更记录
- 2025-08-20：新增实体占位（星河）
- 2025-08-21：v0.2 完成数据字典与关系约束（星河）
- 2025-08-23：v0.3 新增多智能体实体（AgentTask/AgentTrace/AgentConfig/AgentWorker）、枚举、关系与业务规则（星河）