# 质量保证计划（SQAP）— 星河超脑 V2.3

> 更新公告（2025-08-22）
> - 新增质量域：云端持续进化与远程记忆同步，要求“可撤销、可观测、最小采集”。
> - 新增门禁：隐私与合规门禁（数据最小化、去标识化、密钥/机密零泄露）；云端同步影子回放与差异阈值门禁。
> - 度量补充：用户确认率、回滚率、撤销/擦除权SLA、云端同步成功率。


版本：V2.3 初版  | 所属阶段：概念设计/开发准备  | 适用范围：全项目

## 1. 目的与范围
- 目的：建立可度量、可执行、可追踪的质量管理体系，确保 V2.3
  在功能正确性、稳定性、性能与安全合规方面达到既定 SLO。
- 范围：覆盖需求、设计、编码、测试、发布与运维的全生命周期。

## 2. 质量目标（量化 SLO）
- 功能正确性：核心接口（/consciousness, /memory, /reasoning）
  契约测试通过率 ≥ 99.5%。
- 覆盖率门槛：语句 ≥ 85%，分支 ≥ 75%，新增代码 ≥ 90%。
- 性能：关键接口 P95 响应时间 ≤ 200ms（测试环境基线）。
- 稳定性：集成回归通过率 100%；发布前阻断性缺陷为 0。
- 安全：不允许存在高危漏洞（在发布前全部关闭或隔离）。

## 3. 组织与角色
- 质量负责人（QA Lead）：统筹质量计划、度量与报告。
- 架构评审委员（ARC）：把关关键设计与技术方案可测性。
- 模块负责人（Owner）：提交自测报告，落实门禁要求。
- 自动化守护（CI/CD）：执行门禁、生成报表、阻断不合格变更。

## 4. 质量活动与流程
1) 需求与设计
   - 需求评审：可测性清单、验收标准（DoD）必须明确。
   - 设计评审：接口契约（OpenAPI/JSONSchema）、异常语义、
     性能预算、可观测性点（metrics/log/trace）。
2) 编码与自测
   - 单元测试：每个模块随改随测；Mock/Fixture 完整。
   - 静态检查：flake8、isort、bandit；禁止未使用导入与长行。
   - 类型检查（如启用）：关键数据通路需通过。
3) 集成与回归
   - 契约测试：Provider/Consumer 双向验证；破坏性变更需公告。
   - 集成测试：跨引擎流程（意识→记忆→推理→执行）。
   - 回归测试：按测试套件标签分层执行（smoke/regression/perf）。
4) 真实性验证（影子流量）
   - 录制/回放：对关键接口进行影子流量回放，生成差异报告。
5) 性能与安全
   - 性能基线：端到端、接口级压测；监控 P50/P95/P99。
   - 安全扫描：依赖与源码安全，禁止高危合入。

## 5. 质量门禁（CI 必过）
- 构建成功、单元测试通过且覆盖率达标。
- Lint/安全扫描无阻断问题（高危=阻断，中危=需豁免单）。
- 契约测试、集成回归全部通过。
- 变更审查：至少 1 名 Owner + 1 名 ARC 审批通过。

## 6. 测试策略与用例
- 参照概念设计方案中的“测试计划/测试用例模板”。
- 用例组织：tests/ 下按模块与层级划分，支持标签化执行。
- 数据管理：固定基线数据 + 随机化补充，确保可重复性。

## 7. 度量指标与报告
- 质量看板：测试通过率、覆盖率、缺陷趋势、漏测率、MTTR。
- 缺陷管理：等级（Blocker/Critical/Major/Minor），修复时限：
  - Blocker：当天修复并回归；Critical：24h；Major：3d；
    Minor：按迭代安排。
- 周报与里程碑复盘：形成质量改进项池（持续跟踪）。

## 8. 环境与工具
- CI/CD：Git 平台工作流（含并行测试、门禁、报告归档）。
- 测试框架：pytest + coverage；静态检查：flake8/isort/bandit。
- 报表归档：reports/ 下按日期与里程碑归档，支持追溯。

## 9. 风险与应对
- 风险：门禁标准不一致、数据不真实、影子流量覆盖不足。
- 应对：统一门禁模板与阈值；加强真实数据校验；
  关键路径强制影子回放与差异门槛。

## 10. 交付物
- 评审记录（需求/设计/代码）、测试报告、覆盖率报告、
  契约验证报告、性能与安全扫描报告、差异分析报告。

## 11. 附录：检查清单（节选）
- [ ] 需求可测性与验收标准完整
- [ ] 接口契约/错误码/异常语义明确
- [ ] 单测≥85%/分支≥75%/新增≥90%
- [ ] Lint/安全扫描通过且无高危
- [ ] 契约/集成/回归全部通过
- [ ] 影子流量差异在阈值内
- [ ] 质量报告与归档完成

## 12. 阶段与门禁执行摘要（对齐 .workflow/phase_history.json）

- 数据来源：.workflow/phase_history.json；last_updated: 2025-07-13T22:24:42.688294
- 近两次阶段执行：development × 2，均为 fail（duration ≈ 0.81s ~ 0.87s）

### 12.1 门禁结果汇总
- syntax_check：pass（total_files=0，issues_found=0）
- unit_test：fail（errors=2；在收集阶段报错）
  - 典型日志要点：
    - PytestCollectionWarning：cannot collect test class 'TestFixer' / 'TestResult' / 'TestFramework'，因为这些类定义了 __init__ 构造函数
    - Interrupted：1 error during collection at tests\test_starriver_comprehensive.py
- code_review：pass（complexity=A，maintainability_index=85）

### 12.2 处置与修复建议（执行顺序）
1) 调整测试用例以符合 pytest 规范：
   - 测试类不应定义 __init__；改用 fixture（@pytest.fixture）与函数式/面向对象但无 __init__ 的结构。
   - 确认测试文件/类/函数命名规范（test_*.py、类名以 Test 开头、函数以 test_ 开头）。
2) 修复 tests\\test_starriver_comprehensive.py 的收集错误：
   - 排查导入路径、名称冲突、意外副作用（全局执行时导入即运行）。
3) 本地验证流程：
   - 先运行：pytest -q（或带标签分层执行），确保无收集错误且断言通过。
   - 再运行集成+Postman 联合验证脚本：
     - PowerShell 示例：
       - $env:API_BASE_URL = "http://127.0.0.1:8230"
       - python C:\\星河超脑\\星河超脑\\V2.3\\tests\\scripts\\run_status_validation.py --api $env:API_BASE_URL
4) 提交 MR 后触发 CI 门禁重跑：目标为所有 gate=pass，success_rate>0，覆盖率达成基线（语句≥85%，分支≥75%，新增≥90%）。

### 12.3 最新本地验证快照（信息同步）
- 2025-08-30 本地通过联合验证脚本运行结果：
  - 测试总数：17；全部通过；覆盖率：100%；/health 返回 status=ok。
  - 说明：该结果已在本地验证通过，待 CI 阶段作业同步刷新 phase_history 后形成统一口径。

### 12.4 风险与后续计划
- 若仍出现 test collection 错误：
  - 检查 conftest.py、pytest.ini、路径/命名规范与副作用导入；确保 Test* 类不含 __init__。
- 报告归档：下一轮阶段门禁报告与联合验证 JSON 产物建议归档到 V2.3/docs/testing/reports 或统一 reports/ 路径，便于追溯。