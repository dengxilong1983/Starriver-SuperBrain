# 架构设计说明（V2.3）

> 更新公告（2025-08-23）
> - 新增章节：意识核心 v0、可观测矩阵 v0、安全与回滚、接口映射。
> - 对齐当前实现：FastAPI + Uvicorn，预览命名空间 /api/v2.3-preview。
> - 观测与审计：X-Request-Id 透传与服务端生成、关键操作结构化日志。
> - **【NEW】多智能体系统架构**：星河Orchestrator v0，支持Breadth-First研究任务。

- 版本：V2.3
- 文档状态：v0.4（集成多智能体架构）
- 作者：星河
- 最近修订：2025-08-23

## 1. 技术栈与原则
- 技术栈：Python 3.10+、FastAPI、Uvicorn、Pydantic、CORS（全开放用于本地联调）。
- 设计原则：文档驱动、契约优先（OpenAPI）、最小必要复杂度（MNC）、可回退、可观测。
- 命名空间：所有预览接口挂载于 /api/v2.3-preview（根路径和健康检查除外）。

## 2. 系统架构（预览）
- 模块划分：
  - Consciousness（意识）：/consciousness/state（GET/POST）
  - Memory（记忆）：/memory/sync（POST）、/memory/export（GET）
  - Reasoning（推理）：/reasoning/plan（POST）
  - Execution（执行）：/execution/act（POST）
  - Cloud（云授权）：/cloud/consent（POST/DELETE）、/cloud/status（GET）
  - **Agents（多智能体）**：/agents/run（POST）- 新增多智能体调度端点
  - Meta & Health：根路径 / 与 /health
- 部署拓扑：本地单进程（Uvicorn），跨域允许；后续可按模块横向拆分为微服务或函数化运行。
- 数据流：当前为内存态占位实现；后续引入持久层与消息队列（见演进计划）。

## 3. 关键设计
### 3.1 意识核心 v0（最小可用）
- 抽象：目标（Goal）/状态机（idle→focus→act→reflect）/注意力路由（基于端点与上下文）/记忆门控（读/写/引用策略）。
- 外部接口：/consciousness/state（GET/POST）。当前实现为内存态，后续接入记忆系统与计划器。
- 与 IDE 大模型协同：意识态影响调用策略与资源预算（预留策略钩子）。

### 3.2 多智能体系统架构 v0
#### 3.2.1 整体架构模式
- **范式**：Orchestrator-Worker模式，参考Anthropic多智能体研究系统设计
- **核心角色**：
  - LeadResearcher（指挥中心）：负责任务分解、策略规划、结果综合
  - SearchAgent（搜索智能体）：并行执行网络搜索与数据检索
  - SynthesisAgent（综合智能体）：信息去重、质量评估与知识整合
  - CitationAgent（引用智能体）：可信度评估与引用格式化

#### 3.2.2 接口设计
```yaml
POST /api/v2.3-preview/agents/run
Request:
  task_type: "breadth_first_research" | "single_agent_analysis"
  query: string
  max_agents: number (default: 3, max: 5)
  budget: { time_limit: number, cost_limit: number }
  quality_threshold: number (0.0-1.0)
  
Response:
  task_id: string
  status: "pending" | "in_progress" | "completed" | "failed"
  results: {
    synthesis: string,
    citations: [{ source: string, credibility: number, snippet: string }],
    confidence: number,
    coverage_score: number
  }
  agents_used: number
  cost_breakdown: { search: number, synthesis: number, total: number }
```

#### 3.2.3 调度策略
- **任务分解**：基于查询复杂度自动确定子任务数量与边界
- **并行执行**：Worker智能体独立搜索，通过Interleaved Thinking评估结果
- **预算守恒**：时间与成本双重约束，超预算自动熔断
- **失败恢复**：单个Worker失败不影响全局，支持部分结果返回

#### 3.2.4 记忆与状态管理
- **任务记忆**：保存分解策略、中间结果、决策轨迹
- **引用知识库**：缓存高质量源与可信度评分
- **反思循环**：根据结果质量调整下次分解策略

### 3.3 可观测矩阵 v0
- 追踪：请求头 X-Request-Id 透传，若缺失则服务端生成并在响应头回显 X-Server-Request-Id。
- 日志：结构化日志（method, path, status, duration_ms, req_id）。默认输出到控制台。
- 指标：预留端点级计数与延迟直方图埋点（后续接 Prometheus/OpenTelemetry）。
- **多智能体监控**：Worker调度时延、并发数、成功率、成本效率等专项指标

### 3.4 安全与回滚
- 安全基线：最小权限、无敏感明文；本地默认关闭鉴权以便联调，生产启用 Bearer/OIDC。
- 回滚策略：
  - 接口级：写操作预留 Idempotency-Key 语义（契约已定义，代码将对齐）。
  - 数据级：预览期以软状态为主（内存态），后续引入软删除与变更日志以支持快速回滚。
- **多智能体安全**：Worker沙箱隔离、搜索结果内容过滤、引用源验证

## 4. 非功能设计（目标）
- 性能：P95 ≤ 300ms（本地环境基线），多智能体任务 P95 ≤ 5s
- 可靠性：SLO ≥ 99.9%（预览环境）；关键链路错误率 ≤ 0.1%。
- 可观测性：核心指标/日志/追踪齐备；SLA 告警路由有效。
- 合规：采集最小化，授权可撤销，导出可脱敏，审计留痕全链路。
- **多智能体性能**：支持最大5个并发Worker，预算可配置，支持优雅降级

## 5. 接口映射与命名空间
- 命名空间前缀：/api/v2.3-preview。
- 模块→端点映射：
  - Consciousness → GET/POST /consciousness/state
  - Memory → POST /memory/sync, GET /memory/export
  - Reasoning → POST /reasoning/plan
  - Execution → POST /execution/act
  - Cloud → POST/DELETE /cloud/consent, GET /cloud/status
  - **Agents → POST /agents/run** （新增）
  - Health/Meta → GET /health, GET /

## 6. 多智能体决策阈值与策略
### 6.1 何时选择多智能体
- 查询需要探索≥3个独立方向
- 单次搜索结果不足以覆盖主题广度
- 用户明确要求"全面研究"或"多角度分析"
- 时间预算充足（≥30秒）且成本预算允许

### 6.2 何时选择单智能体
- 查询明确且范围有限
- 需要快速响应（<10秒）
- 成本敏感场景
- 已有足够上下文或缓存结果

### 6.3 折中策略
- 混合模式：单智能体打底+多智能体补充
- 渐进式扩展：根据初始结果质量决定是否启动多智能体
- 用户选择：提供任务类型选择器，支持显式指定

## 7. 演进路线（摘要）
- 契约对齐：按 docs/requirements/api/openapi_v2.3-preview.yaml 对齐字段与错误码。
- 可观测增强：接入 OpenTelemetry/Prometheus；审计日志持久化。
- 意识 v1：加入多目标优先队列与反思循环，记忆门控策略化。
- **多智能体v1**：引入强化学习优化调度策略，支持更多Worker类型
- 规模化：限流/熔断/幂等落地；多实例与水平扩展方案。

## 8. 多智能体质量门禁 v0
### 8.1 任务分解质量门
- 子任务边界清晰，无重叠与遗漏
- 任务描述具体，包含预期输出格式
- 并行度合理，符合查询复杂度

### 8.2 执行质量门
- Worker独立性验证，无相互依赖
- 超时与异常处理完备
- 结果格式一致性检查

### 8.3 综合质量门
- 信息去重与一致性验证
- 引用可信度≥0.7的比例≥50%
- 最终置信度评分合理且可解释

---

**更新说明**：本版本新增多智能体系统架构设计，为V2.3版本的智能化能力升级奠定了技术基础，支持从单智能体到多智能体的平滑演进。