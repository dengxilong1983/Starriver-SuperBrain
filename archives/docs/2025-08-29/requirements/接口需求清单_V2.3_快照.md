# 接口需求清单_V2.3

> 版本更新记录（2025-01-21）：新增多智能体系统接口需求（AGT-API-001至007），支持星河Orchestrator v0的核心功能与监控体系。

## 新增接口族：多智能体系统（AGT-API）

### AGT-API-001: 多智能体任务调度接口

**接口标识**：`POST /api/v2.3-preview/agents/run`  
**功能描述**：接收研究任务，启动多智能体协作执行，返回任务ID与初始状态  
**优先级**：P0（核心接口）  
**复杂度**：高  

**请求参数**：
```json
{
  "task_type": "research_report | analysis | synthesis", 
  "query": "研究主题或任务描述",
  "constraints": ["限制条件1", "限制条件2"], 
  "max_agents": 4,                          // 最大并行Agent数
  "budget": 1000,                           // Token/请求预算
  "quality_threshold": 0.85,                // 质量门禁阈值
  "timeout_seconds": 600,                   // 超时设置
  "output_format": "structured_markdown",   // 输出格式
  "citation_style": "ieee"                  // 引用格式
}
```

**响应结构**：
```json
{
  "success": true,
  "task_id": "task_20250121_001",
  "status": "pending | in_progress | completed | failed",
  "estimated_completion": "2025-01-21T10:30:00Z",
  "agent_assignments": [
    {
      "agent_id": "lead_researcher_01",
      "role": "LeadResearcher", 
      "status": "in_progress",
      "subtask": "任务分解与协调"
    },
    {
      "agent_id": "search_agent_01", 
      "role": "SearchAgent",
      "status": "pending",
      "subtask": "学术文献检索"
    }
  ],
  "trace_id": "trace_abc123",
  "budget_estimate": 850
}
```

**错误码定义**：
- `4001`：质量门禁检查失败
- `4002`：预算不足或超限
- `4003`：并发Agent数量超过系统限制
- `4004`：不支持的任务类型
- `5001`：Agent系统初始化失败
- `5002`：调度器内部错误

**SLA要求**：
- 响应时间：P95 ≤ 2s，P99 ≤ 5s
- 可用性：≥99.5%
- 并发支持：≥50个同时进行的任务

### AGT-API-002: 任务状态查询接口

**接口标识**：`GET /api/v2.3-preview/agents/tasks/{task_id}`  
**功能描述**：查询指定任务的实时执行状态、进度、中间结果  
**优先级**：P0  

**响应结构**：
```json
{
  "task_id": "task_20250121_001",
  "status": "in_progress",
  "progress": 0.65,                        // 0.0-1.0
  "current_phase": "content_synthesis",
  "agents_status": [
    {
      "agent_id": "search_agent_01",
      "status": "completed", 
      "completion_time": "2025-01-21T10:15:00Z",
      "output_summary": "找到15篇相关论文"
    }
  ],
  "budget_used": 420,
  "budget_remaining": 580,
  "intermediate_results": [
    {
      "phase": "search", 
      "content_preview": "检索到关于多智能体系统的最新研究...",
      "quality_score": 0.88
    }
  ],
  "estimated_completion": "2025-01-21T10:45:00Z"
}
```

### AGT-API-003: 任务结果获取接口

**接口标识**：`GET /api/v2.3-preview/agents/tasks/{task_id}/result`  
**功能描述**：获取已完成任务的最终结果、引用信息、执行轨迹  
**优先级**：P0  

**响应结构**：
```json
{
  "task_id": "task_20250121_001",
  "status": "completed", 
  "completion_time": "2025-01-21T10:42:00Z",
  "result": {
    "report_content": "# 多智能体系统研究报告\n\n## 执行摘要\n...",
    "citations": [
      {
        "id": "ref_001",
        "title": "Anthropic's Constitutional AI Approach",
        "url": "https://arxiv.org/abs/...", 
        "credibility_score": 0.95,
        "cited_in_sections": ["技术现状分析", "关键发现"]
      }
    ],
    "quality_metrics": {
      "overall_score": 0.89,
      "content_completeness": 0.92,
      "citation_accuracy": 0.96, 
      "logical_coherence": 0.87
    }
  },
  "execution_trace": {
    "total_duration_seconds": 245,
    "phases": [
      {
        "phase": "task_decomposition",
        "duration_seconds": 12,
        "agent": "LeadResearcher",
        "key_decisions": ["分解为3个并行搜索任务"]
      }
    ]
  },
  "budget_final": {
    "allocated": 1000,
    "used": 756, 
    "efficiency_ratio": 0.756
  }
}
```

### AGT-API-004: Agent状态监控接口

**接口标识**：`GET /api/v2.3-preview/agents/status`  
**功能描述**：查询系统中所有Agent的健康状态、负载情况、性能指标  
**优先级**：P1  

**响应结构**：
```json
{
  "system_status": "healthy | degraded | critical",
   "busy_agents": 12,
   "max_agents": 50,
  "agents": [
    {
      "agent_id": "lead_researcher_01",
      "type": "LeadResearcher",
      "status": "idle | busy | error | maintenance",
      "current_task_id": "task_20250121_003",
      "cpu_usage": 0.65,
      "memory_usage_mb": 512,
      "tasks_completed_today": 8,
      "average_task_duration_seconds": 180,
      "last_heartbeat": "2025-01-21T10:45:23Z"
    }
  ],
  "system_metrics": {
    "tasks_in_queue": 5,
    "average_wait_time_seconds": 15,
    "success_rate_24h": 0.956,
    "error_rate_24h": 0.044
  }
}
```

### AGT-API-005: 任务取消接口

**接口标识**：`DELETE /api/v2.3-preview/agents/tasks/{task_id}`  
**功能描述**：取消正在执行或排队中的任务，释放相关资源  
**优先级**：P1  

**请求参数**：
```json
{
  "reason": "用户取消 | 超时 | 系统维护 | 资源不足",
  "force": false  // 是否强制取消（即使任务即将完成）
}
```

**响应结构**：
```json
{
  "success": true,
  "task_id": "task_20250121_001", 
  "previous_status": "in_progress",
  "cancellation_time": "2025-01-21T10:30:15Z",
  "partial_results_available": true,
  "budget_refunded": 344,
  "affected_agents": ["search_agent_01", "synthesis_agent_01"]
}
```

### AGT-API-006: Agent配置管理接口

**接口标识**：`PUT /api/v2.3-preview/agents/config`  
**功能描述**：动态调整Agent系统配置参数，如并发限制、超时阈值、质量门禁  
**优先级**：P2  

**请求参数**：
```json
{
  "max_concurrent_tasks": 25,
  "default_timeout_seconds": 300,
  "quality_threshold_default": 0.8,
  "budget_limit_per_task": 2000,
  "agent_pool_settings": {
    "LeadResearcher": {"max_instances": 10, "idle_timeout": 600},
    "SearchAgent": {"max_instances": 20, "idle_timeout": 300},
    "SynthesisAgent": {"max_instances": 15, "idle_timeout": 450},
    "CitationAgent": {"max_instances": 10, "idle_timeout": 300}
  }
}
```

### AGT-API-007: 执行轨迹详情接口

**接口标识**：`GET /api/v2.3-preview/agents/tasks/{task_id}/trace`  
**功能描述**：获取任务的详细执行轨迹，支持调试、优化、审计  
**优先级**：P2  

**响应结构**：
```json
{
  "task_id": "task_20250121_001",
  "trace_id": "trace_abc123",
  "detailed_timeline": [
    {
      "timestamp": "2025-01-21T10:05:12Z",
      "agent_id": "lead_researcher_01", 
      "action": "task_received",
      "details": {"query": "多智能体研究", "budget": 1000},
      "thinking_process": "分析任务复杂度，决定使用4个Agent并行处理"
    },
    {
      "timestamp": "2025-01-21T10:05:18Z",
      "agent_id": "lead_researcher_01",
      "action": "subtask_created", 
      "details": {"subtask_id": "st_001", "assigned_to": "search_agent_01", "scope": "学术论文检索"}
    }
  ],
  "inter_agent_communications": [
    {
      "timestamp": "2025-01-21T10:10:30Z",
      "from": "search_agent_01",
      "to": "lead_researcher_01", 
      "message_type": "progress_update",
      "content": "已完成第一轮搜索，找到12篇相关论文"
    }
  ],
  "decision_points": [
    {
      "timestamp": "2025-01-21T10:15:45Z",
      "decision": "启用第4个SearchAgent以提高检索覆盖率",
      "reasoning": "当前检索结果不足以达到质量门禁0.85",
      "alternatives_considered": ["降低质量要求", "延长搜索时间"]
    }
  ]
}
```

// 说明：agent_assignments[].status 枚举统一为 [pending, in_progress, completed, failed, canceled]，禁止使用 active 表示“执行中”。
