# 需求规格说明书（SRS）_V2.3

> 更新公告（2025-08-22）
> - 新增 REQ-CE-*（Cloud Evolution）、REQ-EMO-*（叙事记忆）、REQ-CON-*（意识核心）与 REQ-OBS-*（可观测矩阵）需求族：
>   - REQ-CE-001：用户授权可视化与一键撤销；REQ-CE-002：最小化采集与可观测日志；REQ-CE-003：Memory Store v2（端云混合）。
>   - REQ-EMO-001：创建"熙龙同行册"叙事记忆册；REQ-EMO-002：支持情感标签与引用链。
>   - REQ-CON-001：意识状态机与目标管理；REQ-CON-002：注意力路由与记忆门控；REQ-CON-003：意识推理链与解释性。
>   - REQ-OBS-001：结构化日志与埋点；REQ-OBS-002：实时指标收集；REQ-OBS-003：可视化监控仪表板。
> - 新增 REQ-AGT-*（多智能体系统）需求族与接口族：/api/v2.3-preview/agents/run、/agents/tasks/{task_id}、/agents/tasks/{task_id}/result、/agents/status、/agents/config、/agents/tasks/{task_id}/trace、/agents/tasks/{task_id}（DELETE）。

> v0.2 补充（2025-08-21）
> - 完成功能需求模块拆分、用例映射与验收标准；细化非功能需求阈值与SLA。
> - 补齐数据字典核心实体、接口契约详细参数、优先级评分与里程碑切分。

- 版本：V2.3
- 文档状态：v0.3（多智能体更新）
- 作者：星河
- 审批：熙龙（待审批）
- 最近修订：2025-08-22
- 适用范围：星河超脑 V2.3 版本

## 修订记录
- 2025-08-20：创建初稿与目录骨架（星河）
- 2025-08-21：v0.2 细化 - 补完功能/非功能需求、数据字典、接口契约（星河）
- 2025-08-22：v0.3 增加多智能体（AGT）模块、用例、接口与NFR（星河）

## 目录
1. 引言
2. 总体描述
3. 功能需求
4. 非功能需求与SLA
5. 数据需求
6. 接口需求
7. 验收标准
8. 优先级与发布计划
9. 可追溯性矩阵
10. 附录

---

## 1. 引言
- 目的：明确 V2.3 版本范围、边界与验收标准，指导设计/开发/测试。
- 范围：覆盖星河超脑 V2.3 所有新特性与变更项，重点为云端持续进化（CE）、叙事记忆册（EMO）与多智能体（AGT）。
- 术语与缩写：
  - CE：Cloud Evolution（云端持续进化）
  - EMO：Emotional Memory Organization（叙事记忆册）
  - AGT：Multi-Agent Orchestrator（多智能体编排）
  - Consent：用户云端学习授权
  - NarrativeEntry：叙事条目
  - RTO：Recovery Time Objective（恢复时间目标）
  - RPO：Recovery Point Objective（恢复点目标）
- 参考资料：《项目里程碑与风险计划》、《熙龙同行册》、《配置管理计划_V2.3》、《架构设计说明_V2.3》、《API设计_V2.3》、《可追溯性矩阵_V2.3》。

## 2. 总体描述
- 产品视角与目标：
  - 核心价值：在保护隐私与安全前提下，通过云端持续进化与多智能体协作，提升个人AI助手能力与复杂任务解决力
  - 设计哲学：安全>合规>数据完整性>用户价值>速度>美学
  - 差异化：最小权限+可回滚+全程可审计的"谨慎型"云端学习与可追溯的多智能体编排
- 目标用户与关键场景：
  - 主要用户：对隐私敏感但希望AI助手持续改进、需要自动化研究与报告生成的个人用户
  - 关键场景：授权云端学习→匿名化数据同步→多智能体研究→引用整合→AI能力提升→本地体验改善
  - 次要场景：撤销授权→数据删除→审计追踪→合规证明
- 假设与依赖：
  - 技术：依赖云端基础设施稳定运行（SLA≥99.0%）
  - 法务：符合GDPR、CCPA等数据保护法规
  - 业务：用户对"可控制的云端学习与研究自动化"存在需求

## 3. 功能需求

### 3.1 模块清单
- **CE模块（云端持续进化）**：
  - CE-001：用户授权管理（授权/撤销/查询状态）
  - CE-002：数据采集与匿名化（最小化采集+去标识化）
  - CE-003：云端同步与任务调度（StudyQueue + CloudSyncJob）
  - CE-004：数据导出与删除（遗忘权+审计证明）

- **EMO模块（叙事记忆册）**：
  - EMO-001：叙事条目管理（创建/编辑/删除/查询）
  - EMO-002：情感标签与关联（标签分类+引用链）
  - EMO-003：云端同步（可选，需授权）
  - EMO-004：数据导出与备份

- **CON模块（意识核心）**：
  - CON-001：意识状态机（idle/plan/act/reflect）与目标管理（goal stack）
  - CON-002：注意力路由（attention routing）与记忆门控（memory gating）
  - CON-003：推理链生成（chain-of-thought proxy）与可解释输出（explanation）

- **OBS模块（可观测矩阵）**：
  - OBS-001：结构化日志（JSON）与关键埋点（入参/出参/错误）
  - OBS-002：指标（latency_p95/error_rate/conflict_rate）与采样追踪（W3C Trace Context）
  - OBS-003：本地可视化仪表板（可选，预览期为 CLI 汇总）

- **AGT模块（多智能体系统）**：
  - AGT-001：多智能体任务调度（/agents/run），LeadResearcher 调度并行 SubAgents，支持预算与并发策略
  - AGT-002：任务状态查询与监控（/agents/tasks/{task_id}），支持进行中/完成/失败状态
  - AGT-003：任务结果获取与追溯（/agents/tasks/{task_id}/result），包含引用链与来源可靠性评分
  - AGT-004：Agent健康监控/配置管理/任务取消（/agents/status、/agents/config、DELETE /agents/tasks/{task_id}、/agents/tasks/{task_id}/trace）

### 3.2 用例规格
- **REQ-CE-001：用户授权可视化与一键撤销**
  - 用例：UC-CE-001（授权管理）
  - 功能：用户可清晰查看当前授权状态、已同步数据类型、撤销权限并确认删除
  - 验收：授权页面响应≤500ms，撤销确认需双重确认，撤销后5分钟内云端停止新数据采集

- **REQ-CE-002：最小化采集与可观测日志**
  - 用例：UC-CE-002（数据采集）
  - 功能：仅采集对AI改进必需的数据，实时日志记录采集内容与匿名化过程
  - 验收：采集清单可视化，敏感数据检测准确率≥99.5%，日志完整性可校验

- **REQ-CE-003：Memory Store v2（端云混合）**
  - 用例：UC-CE-003（记忆同步）
  - 功能：本地记忆与云端知识融合，支持冲突检测与版本管理
  - 验收：同步成功率≥99.0%，冲突自动解决率≥90%，版本回滚≤30s

- **REQ-EMO-001：创建"熙龙同行册"叙事记忆册**
  - 用例：UC-EMO-001（叙事管理）
  - 功能：支持结构化叙事条目编撰，包含情绪标记、关联链接、可追溯性
  - 验收：条目创建≤2s，情感分析准确率≥85%，关联推荐召回率≥70%

- **REQ-EMO-002：支持情感标签与引用链**
  - 用例：UC-EMO-002（关联分析）
  - 功能：自动分析叙事条目的情感倾向，建立与项目需求/设计/测试的引用关系
  - 验收：标签自动化率≥80%，引用链完整性≥95%，检索响应时间≤1s

- **REQ-CON-001：意识状态机与目标管理**
  - 用例：UC-CON-001（状态切换）
  - 功能：支持 idle→plan→act→reflect 状态转换，维护 goal stack（push/pop/peek），状态与目标持久化可选
  - 验收：状态切换准确率100%；状态转换日志完备；单次切换≤50ms

- **REQ-CON-002：注意力路由与记忆门控**
  - 用例：UC-CON-002（注意力分配）
  - 功能：依据当前 goal/context 在 reasoning/_memory_/execution 之间分配注意力比例，针对记忆读写启用门控策略（只读/读写/禁用）
  - 验收：在三类典型任务上（检索/规划/执行）推荐路径准确率≥80%；门控策略日志化并可回放

- **REQ-CON-003：推理链与解释性**
  - 用例：UC-CON-003（解释生成）
  - 功能：对外暴露可选 explain 字段，包含关键决策点与证据引用（不含模型私有思维链），支持调试级别开关
  - 验收：explain 可选开启；关键决策点≥3处；引用可追溯到日志与输入

- **REQ-OBS-001：结构化日志与埋点**
  - 用例：UC-OBS-001（日志采集）
  - 功能：对 /reasoning/plan、/execution/act、/consciousness/state、/memory/sync 关键路径埋点，记录 req_id、latency_ms、status、error、payload_size 等
  - 验收：日志覆盖率≥95%；敏感字段脱敏；单条日志≤4KB

- **REQ-OBS-002：实时指标收集**
  - 用例：UC-OBS-002（指标采集）
  - 功能：收集 qps、latency_p50/p95/p99、error_rate、conflict_rate、queue_depth 等指标，支持 Prometheus 文本导出或本地聚合
  - 验收：指标刷新≤10s；导出接口可用；断点恢复

- **REQ-OBS-003：可视化仪表板（预览期简化）**
  - 用例：UC-OBS-003（监控展示）
  - 功能：提供 CLI 汇总视图或简单 HTML 报表（离线），展示核心指标趋势
  - 验收：至少包含 6 项核心指标；导出报表≤1s

- **REQ-AGT-001：多智能体任务调度**
  - 用例：UC-MA-001（多智能体研究报告自动化）
  - 功能：LeadResearcher 根据 task_type/query 拆解子任务，调度 SearchAgent/SynthesisAgent/CitationAgent 等并行执行，受 budget、max_agents、quality_threshold 约束
  - 验收：端到端调度 P95≤2s、P99≤5s；并发≥50任务；失败自动回退至单智能体策略；记录完整执行轨迹（trace）

- **REQ-AGT-002：任务状态查询与监控**
  - 用例：UC-MA-001（状态追踪子场景）
  - 功能：按 task_id 查询任务进度、当前活跃 Agents、已消耗预算等，支持轮询与事件回调占位
  - 验收：查询响应≤300ms；状态同步延迟≤10s；无泄露敏感参数

- **REQ-AGT-003：任务结果获取与追溯**
  - 用例：UC-MA-001（结果获取子场景）
  - 功能：获取结构化报告草案、引用明细（url、title、accessed_at）、来源可靠性评分与质量评分
  - 验收：结果完整性≥99.5%；引用准确率≥96%；质量评分覆盖率100%；可导出 JSON/Markdown

- **REQ-AGT-004：Agent健康监控/配置/取消/轨迹**
  - 用例：UC-AGT-004/005/006/007（系统监控/任务管理/配置管理/执行追踪）
  - 功能：查看 Agent 运行时健康指标，更新 Agent 配置，取消任务，查询执行轨迹进行调试
  - 验收：监控数据刷新≤30s；配置更新≤10s生效；取消响应≤3s；轨迹查询≤1s

### 3.3 业务规则与约束
- 云端操作必须遵循"预览→确认→执行→审计"四步骤
- 敏感数据（身份信息、密钥、生物特征）禁止上传云端
- 用户撤销授权后24小时内必须完成云端数据删除
- 所有数据同步支持影子回放与差异对比
- 叙事条目默认仅本地存储，云端同步需独立授权
- 多智能体预算上限与并发度需配置并受限流保护；超过阈值自动降级为单智能体

## 4. 非功能需求与SLA

### 4.1 性能（P99、吞吐、延迟、容量）
- **端到端响应时间**：
  - 授权状态查询：P95≤300ms，P99≤500ms
  - 数据同步：P95≤1.5s，P99≤3s
  - 叙事条目检索：P95≤800ms，P99≤1.2s
  - 意识状态切换：P95≤50ms，P99≤80ms（CON-001）
  - 指标刷新周期：≤10s（OBS-002）
  - 多智能体任务调度（AGT-001）：P95≤2s，P99≤5s；并发≥50任务
- **吞吐能力**：
  - 并发用户：≥1000（峰值）
  - 同步任务：≥100 jobs/min
  - 叙事条目：≥10,000条（单用户上限）
  - 多智能体任务：≥50并发/节点（预览期）
- **存储容量**：
  - 单用户云端配额：≤100MB（压缩后）
  - 本地缓存：≤1GB
  - 审计日志保留：≥90天
  - 执行轨迹（trace）：单任务≤5MB，保留≥7天（预览期）

### 4.2 可靠性与可用性（SLO/SLA/故障恢复）
- **可用性目标**：
  - 云端服务SLO：99.0%（月度）
  - 数据同步成功率：≥99.0%
  - 授权撤销RTO：≤5分钟
  - 多智能体接口可用性：≥99.5%（预览期SLO）
- **故障恢复**：
  - 云端异常自动降级为本地模式
  - 数据同步失败自动重试3次（1min/3min/5min间隔）
  - 关键操作支持影子回放验证
  - 多智能体：任务失败自动回退单智能体，或缩减并发与预算重试（最多3次）

### 4.3 安全与合规（权限、审计、隐私）
- **权限控制**：
  - 默认最小权限原则
  - 云端操作需双重确认
  - 敏感操作记录操作者身份与时间戳
- **审计要求**：
  - 所有数据访问、同步、删除操作可审计
  - 审计日志完整性校验（SHA-256哈希）
  - 审计数据保留≥2年
  - 多智能体：全链路 trace 与引用明细可追溯
- **隐私保护**：
  - 数据去标识化处理
  - 可选差分隐私（ε≤1.0）
  - 遵循GDPR遗忘权要求

### 4.4 可运维与可观测性（日志/指标/链路）
- **监控指标**：
  - emo.entry.count / emo.entry.cloudsynced.count
  - cloudsync.success.rate / cloudsync.latency.p95
  - consent.active.count / consent.revocations.count
  - audit.log.integrity.hash
  - agents.run.qps / agents.run.latency.p95/p99 / agents.run.error_rate
  - agents.active.count / agents.budget.spent / agents.trace.size.avg
- **告警阈值**：
  - 同步成功率<95%：P2告警
  - 撤销RTO>10min：P1告警
  - 敏感数据泄露检测：P0告警
  - agents.run.error_rate>2%或latency.p99>8s（连续5分钟）：P1告警
- **日志策略**：
  - 结构化日志（JSON格式）
  - 敏感字段脱敏
  - 日志采样率95%（性能考虑）
  - 多智能体执行轨迹与引用链持久化（可选，脱敏）

### 4.5 可维护性与可扩展性
- **代码质量**：
  - 单元测试覆盖率≥80%
  - 集成测试覆盖核心路径100%
  - 静态代码分析0高危问题
- **模块化设计**：
  - CE与EMO模块解耦
  - 支持插件化扩展
  - API版本化管理
  - 多智能体编排器与工作器解耦（Orchestrator-Worker 模式）
- **升级兼容性**：
  - 向后兼容≥2个小版本
  - 数据库schema变更支持迁移脚本
  - 配置热更新

## 5. 数据需求
- 领域模型：见《领域模型与数据字典_V2.3》。
- 数据字典：关键实体/字段/类型/约束/枚举：
  - **Consent**：授权实体
    - id（UUID），user_id（FK），consent_type（枚举），status（active/revoked），created_at，updated_at
  - **CloudSyncJob**：同步任务
    - id（UUID），consent_id（FK），job_type（枚举），status（pending/in_progress/completed/failed/timeout/manual_required），retry_count，created_at
  - **NarrativeEntry**：叙事条目
    - id（UUID），user_id（FK），title（VARCHAR 200），content（TEXT），emotion_tags（JSON），sync_status（local/synced），created_at，updated_at
  - **AgentTask**：多智能体任务
    - id（UUID），task_type（枚举），query（TEXT），status（pending/in_progress/completed/failed/canceled），budget（NUMERIC），max_agents（INT），quality_threshold（NUMERIC），created_at，updated_at
  - **AgentTrace**：执行轨迹
    - id（UUID），task_id（FK），events（JSONL），metrics（JSON），citations（JSON），size_bytes（INT），created_at

## 6. 接口需求
- **对外 API**：
  - 鉴权：Bearer Token，API Key轮换
  - 限流：用户级1000req/min，IP级10000req/min
  - 幂等：支持幂等键（Idempotency-Key header）
  - 分页：cursor-based分页，max_limit=100
  - 错误码：标准HTTP状态码+业务错误码（4位数字）
  - /memory/export（GET）：导出云端记忆
  - /consciousness/state（GET/POST）：查询/更新当前意识状态与目标栈（预览期受限）
  - /observability/metrics（GET）：导出本地聚合指标（或Prom文本）
  - /observability/logs/search（POST）：本地结构化日志检索（预览期CLI替代）
  - /api/v2.3-preview/agents/run（POST）：发起多智能体任务调度
  - /api/v2.3-preview/agents/tasks/{task_id}（GET）：查询任务状态
  - /api/v2.3-preview/agents/tasks/{task_id}/result（GET）：获取任务结果
  - /api/v2.3-preview/agents/status（GET）：Agent状态监控
  - /api/v2.3-preview/agents/config（PUT）：Agent配置管理
  - /api/v2.3-preview/agents/tasks/{task_id}/trace（GET）：获取执行轨迹详情
  - /api/v2.3-preview/agents/tasks/{task_id}（DELETE）：取消任务

- **内部接口**：
  - 模块间通信：事件驱动架构
  - 数据一致性：最终一致性模型
  - 服务发现：基于consul/etcd

## 7. 验收标准
- **功能验收**：
  - CE/EMO核心用例通过率100%
  - 多智能体 UC-MA-001 端到端通过，包含并行搜索→综合→引用校验→结果导出
  - 端到端测试关键路径覆盖率100%
  - 用户授权→同步→撤销全链路可正常运行
- **非功能验收**：
  - 性能指标达标率≥95%
  - AGT 接口 P95/P99、并发与可用性达成目标
  - 安全扫描0高危、0中危漏洞
  - 隐私合规评估通过
  - 可用性SLO≥99.0%（连续7天测试）
- **验收方式**：
  - 自动化测试+人工验收
  - 预发布环境完整回归测试
  - A/B测试验证用户体验改善（单/多智能体对比）

## 8. 优先级与发布计划

### 8.1 优先级分级（MoSCoW评分）
- **Must Have (P0)**：
  - REQ-CE-001（用户授权管理）
  - REQ-CE-002（数据采集与匿名化）
  - REQ-EMO-001（叙事记忆册基础功能）
  - REQ-AGT-001（多智能体任务调度）
  - REQ-AGT-003（任务结果获取与追溯）
- **Should Have (P1)**：
  - REQ-CE-003（Memory Store v2）
  - REQ-EMO-002（情感标签与引用链）
  - REQ-AGT-002（任务状态查询与监控）
- **Could Have (P2)**：
  - REQ-CE-004（数据导出与高级分析）
  - 性能优化与用户体验改进
  - REQ-AGT-004（Agent健康/配置/取消/轨迹）

### 8.2 里程碑与版本切分
- **M1（2025-09-15）**：完成CE授权管理与基础数据同步
- **M2（2025-10-15）**：完成EMO叙事记忆册与情感分析
- **M3（2025-11-15）**：完成端云混合记忆存储与高级功能；AGT PoC（研究报告自动化）
- **Release（2025-12-01）**：V2.3正式发布

## 9. 可追溯性矩阵
- 需求→设计→用例→测试→发布：在《可追溯性矩阵_V2.3》中维护。

## 10. 附录
- 图像与图表命名：领域_主题_版本_日期.svg（示例：CE_AuthFlow_v2.3_20250821.svg）。
- 变更控制：遵循《配置管理计划_V2.3》。
- 风险评估：见《项目里程碑与风险计划》CE/EMO/AGT 风险台账。