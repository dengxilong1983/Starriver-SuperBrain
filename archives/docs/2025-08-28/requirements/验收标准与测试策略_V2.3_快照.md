# 验收标准与测试策略_V2.3

> 更新公告（2025-08-22）
> - 云端授权/撤销全链路可回滚纳入验收红线；新增 Study Queue/同步调度稳定性测试。

> v0.2 补充（2025-08-21）
> - 完成测试计划、用例分层与门禁阈值；增加契约测试与回归策略；补充可观测性验收。

- 版本：V2.3
- 文档状态：v0.2（初版完成）
- 作者：星河
- 审批：熙龙（待审批）
- 最近修订：2025-08-27

## 1. 测试范围与目标
- 覆盖功能（CE/EMO）、非功能（性能/可靠性/安全/可观测性）、接口契约、数据一致性与回滚。

## 2. 测试分层
- 单元测试：模块内逻辑，覆盖率≥80%。
- 集成测试：端到端流程（授权→同步→导出→撤销），关键链路 0 P0 缺陷。
- 契约测试：/cloud/consent, /cloud/status, /memory/sync, /memory/export 的请求/响应 schema 校验；错误码与幂等性校验。
- E2E 测试：真实用户路径与场景。
- 非功能测试：性能、可靠性、可用性、安全、可观测性。

## 3. 用例集与标识
- CE-UC-001：授权创建（正/反向）
- CE-UC-002：授权撤销（回滚验证）
- CE-UC-003：增量同步（幂等+冲突）
- CE-UC-004：导出与下载（数据脱敏）
- EMO-UC-001：叙事条目增删改查（软删除恢复）
- EMO-UC-002：情感标签与引用链（权重与拓扑）

测试用例 ID 规范：
- TC-[Layer]-[Module]-[Seq]，例如：TC-INT-CE-001（集成-云端-授权创建）。

## 4. 验收门禁（Definition of Done）
- 功能：P0=0，P1≤2 且已修复，P2 可遗留但需登记并纳入下版计划。
- 非功能：
  - 性能：P95 延迟 ≤ 300ms；吞吐 ≥ 100 RPS；/memory/export 10MB 完成 ≤ 5s。
  - 可靠性：月度 SLO ≥ 99.9%；关键链路错误率 ≤ 0.1%。
  - 安全：最小权限、加密、审计日志完整，隐私脱敏通过抽样检查（误报 ≤ 1%）。
  - 可观测性：核心指标/日志/追踪齐全；SLA 告警路由有效；演练通过。
- 可回滚：发布回滚在 5 分钟内可完成，数据回滚（软删除恢复）≤ 10 分钟。

## 5. 契约测试规范
- 使用固定 schema（OpenAPI v3）进行请求/响应校验；幂等键 Idempotency-Key 语义与过期策略一致。
- 错误码与 HTTP 状态码对齐：4xx 客户端可重试策略禁止，5xx 触发指数退避重试。
- 限流：按用户令牌 100 RPM；超限期望返回 429，含重试建议头。

## 6. 性能与可靠性测试
- 压测配置：
  - 基线：20→50→100 RPS 梯度；持续 15 分钟每档，观测 P95/P99、错误率、资源占用。
  - 峰值：200 RPS 短冲 2 分钟；验证自动扩缩/退避。
- 稳定性：
  - 同步调度 24h 稳定运行，内存泄漏≤1%，平均重试≤0.5 次/作业。
  - 队列水位>80% 降级策略触发并恢复正常后自动回补。

## 7. 安全与合规模拟
- 鉴权：过期令牌、权限不足、签名错误；均需精确错误码与审计日志。
- DLP：导出数据进行关键字段脱敏检查（邮箱/手机号等）。
- 审计：关键操作（授权/撤销/导出）需完整链路追踪与不可篡改日志校验。

## 8. 回归策略
- 冒烟：提交合并后自动触发核心 30 条用例。
- 周回归：覆盖全部 P0/P1 用例与 NFR 关键项。
- 契约回归：接口 schema 变更需向后兼容并附弃用公告；非兼容需走变更审批。

## 9. 追溯与报表
- 追溯矩阵：REQ-CE-*/REQ-EMO-* ↔ 用例 ID ↔ 测试用例 TC-* ↔ 缺陷单。
- 追溯矩阵（AGT）：REQ-AGT-* ↔ 用例 UC-MA-* ↔ AGT API（/agents/*）↔ 测试用例 ↔ 可观测性指标。
- 测试报告：包含覆盖率、缺陷统计、NFR 指标、告警与演练结果、回归通过率。

## 10. 变更记录
- 2025-08-20：补充红线与策略（星河）
- 2025-08-21：v0.2 完成测试计划、门禁与回归（星河）
- 2025-08-28：统一状态枚举与门禁补充（星河）——统一采用 pending/in_progress/completed/failed；CloudSyncJob 增加 timeout、manual_required；禁止使用 running/success/error 等旧值。

## 接口契约测试与门禁（v2.3-preview）
- 覆盖率要求：
  - 路径覆盖 ≥ 95%，operationId 覆盖 ≥ 90%。
  - 关键端点（/cloud/consent, /memory/sync, /agents/run）需达到 100% 基本场景覆盖。
- 失败门禁：
  - 契约校验阻断级失败（例如 schema 不一致、未定义状态码）≥1 条 → 拒收。
  - 5xx 比例 > 0.1% 或 未在规格内定义的 4xx → 拒收。
- 测试工具：
  - 首选 Schemathesis（属性测试），辅以 Dredd（契约一致性）。
  - 本地自测可对接 Prism Mock，联调阶段指向真实后端。
  - Postman/Newman（补充）：用于状态枚举与字段一致性断言快速校验。
  - 集合路径：V2.3/tests/postman/status_enum_v2.3.postman_collection.json
  - 环境路径：V2.3/tests/postman/postman_environment_local.json
  - 一键运行脚本：V2.3/tools/scripts/run_postman_collection.ps1

### 报告归档与留痕（新增，2025-08-28）
- 报告输出目录：V2.3/reports/testing/postman/
- 报告格式：HTML（htmlextra）、JSON（完整断言详情）
- 触发方式：本地或CI执行上述脚本，自动生成带时间戳的报告文件。
- 门禁要求：如报告中出现“status 不在允许集合”或“包含禁用值 running/success/error”的断言失败，构建即判为失败（阻断级）。
- 追溯方式：每次执行的JSON报告需保留，支持历史对比与回归分析。
- 状态枚举与字段一致性断言
- ExecutionResult.status ∈ { pending, in_progress, completed, failed }；不得出现 success/error。
- CloudSyncJob.status ∈ { pending, in_progress, completed, failed, timeout, manual_required }。
- 如响应体出现 running/success/error 等不在契约中的状态值：判定为契约失败（阻断级），本次发布拒收。

- 产出物：
  - 契约测试报告（HTML/JSON）与测试日志（含 X-Request-Id）。
  - 执行命令与版本留痕，关联 OpenAPI 契约文件 docs/requirements/api/openapi_v2.3-preview.yaml。
- 回归策略：
  - 任何 OpenAPI 契约变更、错误码表调整或限流策略变更，必须重新执行契约测试并归档报告。

### Agents 端点覆盖与校验
- 覆盖路径清单：
  - POST /agents/run（返回 job/task 标识；若提供 Idempotency-Key，则需幂等语义一致）。
  - GET /agents/status（返回 { pending, in_progress, completed, failed } 等任务聚合字段）。
  - GET /agents/tasks/{task_id}（返回任务状态与进度；status ∈ [pending, in_progress, completed, failed, canceled, timeout]）。
  - GET /agents/tasks/{task_id}/result（完成时返回 200 + 结果；未完成返回 404）。
  - GET /agents/tasks/{task_id}/trace（返回步骤级轨迹 events[]，含 stepId、agentId、timestamp、action、cost）。
  - DELETE /agents/tasks/{task_id}（取消：允许状态下返回 202；已终态返回 409 或 404）。
  - PUT /agents/config（更新配置：max_agents、quality_threshold、tooling 开关等；返回 200 + 生效配置）。
- 校验项：
  - 请求/响应 schema 与 openapi_v2.3-preview.yaml 一致；未定义字段被拒绝（422）。
  - 错误码表：400（校验失败）、401/403（鉴权/鉴权不足）、404（任务不存在）、409（状态冲突/不可取消）、429（限流）、5xx（后端错误）。
  - 限流与重试：对 /agents/* 按用户/租户限流；429 含重试建议头；5xx 采用指数退避。
  - 观测：所有 /agents/* 返回中均应包含 X-Request-Id；trace 事件需具备最小字段集且可关联。


---

## 多智能体评测与验收（v2.3-preview）
- 评测范围：覆盖 UC-MA-001（研究报告自动化）等研究类任务，验证 /agents/run 编排质量、成本与时延三维指标。
- 质量维度：
  - 正确性与事实一致性：自动评分（基于参考答案与规则）≥ quality_threshold（默认 0.8）。
  - 引用与可追溯性：关键论断需有引用且可解析；断链/缺引用 ≤ 5%。
  - 冗余与重复率：重复内容占比 ≤ 15%。
- 资源与约束：
  - 预算遵循请求体 budget（tokens/seconds），超限即失败；墙钟时间 ≤ budget.seconds。
  - 并发与并行度不超过 max_agents，拒绝不必要的级联调用。
- 可复现性：
  - 固定随机种子与工具配置后，轨迹可复现率 ≥ 85%（以步骤级相似度衡量）。
  - 产出需含 Agent-Job-Id、Step-Id 与 X-Request-Id，支持回放。
- 安全与合规：
  - 不得输出敏感信息或违反内容政策；安全 P0=0。
- A/B 对比门槛：
  - 与单智能体基线相比，满足以下任一：质量 +10% 以上；或在质量持平（±1%）下，端到端延迟降低 ≥ 20%。
- 评测资产：
  - 数据集：UC-MA-001 任务集（内部标注）；评测脚手架与评分脚本（reports 生成）。
  - 报告：包含质量-成本-时延雷达图与结论摘要，归档至 docs/requirements/api/reports/。

## 最小后端骨架状态更新（v2.3-preview）
- 进展：最小后端骨架（FastAPI）已落地并通过本地冒烟：根路径 / 与 /health 正常；/consciousness、/memory、/reasoning、/execution、/cloud 模块均已提供占位实现。
- 命名空间：所有预览接口挂载于 /api/v2.3-preview（根与健康检查除外）。
- 契约对齐：OpenAPI servers 已更新至 /api/v2.3-preview；以下端点与契约仍存在差异，已纳入下一步改造：
  - cloud/consent：请求/响应将对齐 Consent 标准字段与 201 语义。
  - cloud/status：将对齐为 { active, expiresAt, lastJob }。
  - memory/sync：将对齐为 { clientCommitId, items } → 返回 202 + CloudSyncJob。
  - memory/export：将对齐 { downloadUrl, expiresAt, checksum }。
- 观测：支持 X-Request-Id 透传与服务端生成 X-Server-Request-Id；结构化日志输出到控制台。
- 门禁建议：以 Schemathesis（属性测试）与 Dredd（契约一致性）作为发布门禁。

### 本地冒烟清单与命令
- 根与健康
  - curl -i http://127.0.0.1:8230/
  - curl -i http://127.0.0.1:8230/health
- 推理计划（应返回 200 + planId/steps）
  - curl -s -X POST "http://127.0.0.1:8230/api/v2.3-preview/reasoning/plan" -H "Content-Type: application/json" -d '{ "goal": "demo", "constraints": [], "max_steps": 2 }'
- 执行动作（应返回 200 + echo 输出）
  - curl -s -X POST "http://127.0.0.1:8230/api/v2.3-preview/execution/act" -H "Content-Type: application/json" -d '{ "action": "echo", "params": { "hello": "world" } }'
- 云授权（创建 → 查询 → 撤销）
  - curl -s -X POST "http://127.0.0.1:8230/api/v2.3-preview/cloud/consent" -H "Content-Type: application/json" -d '{ "user_id": "u-001", "consent": true, "scopes": ["dialog"] }'
  - curl -s "http://127.0.0.1:8230/api/v2.3-preview/cloud/status?user_id=u-001"
  - curl -s -X DELETE "http://127.0.0.1:8230/api/v2.3-preview/cloud/consent?user_id=u-001"
- 记忆（同步 → 导出）
  - curl -s -X POST "http://127.0.0.1:8230/api/v2.3-preview/memory/sync" -H "Content-Type: application/json" -d '{ "items": [ { "content": { "type": "note", "text": "hello" } } ] }'
  - curl -s "http://127.0.0.1:8230/api/v2.3-preview/memory/export"
- 多智能体调度（应返回 200 + 同步结果或 Job 占位）
  - curl -s -X POST "http://127.0.0.1:8230/api/v2.3-preview/agents/run" -H "Content-Type: application/json" -d '{ "task_type": "research_report", "query": "Transformer架构演进", "max_agents": 3, "budget": { "tokens": 20000, "seconds": 60 }, "quality_threshold": 0.8 }'
  - curl -s "http://127.0.0.1:8230/api/v2.3-preview/agents/status"
  - curl -s -X PUT "http://127.0.0.1:8230/api/v2.3-preview/agents/config" -H "Content-Type: application/json" -d '{ "max_agents": 3, "quality_threshold": 0.8 }'
  - # 将 {task_id} 替换为上一步返回的 taskId/jobId
  - curl -s "http://127.0.0.1:8230/api/v2.3-preview/agents/tasks/{task_id}"
  - curl -s "http://127.0.0.1:8230/api/v2.3-preview/agents/tasks/{task_id}/result"
  - curl -s "http://127.0.0.1:8230/api/v2.3-preview/agents/tasks/{task_id}/trace"
  - curl -s -X DELETE "http://127.0.0.1:8230/api/v2.3-preview/agents/tasks/{task_id}"

判定标准：
- 200/201/202 返回 JSON，字段与示例一致；422 为 JSON 格式/校验错误（修正请求体后应通过）；5xx 视为失败。

下一步门禁：
- 契约对齐后执行 Schemathesis + Dredd 并归档报告，契约失败即拒收；契约文件：docs/requirements/api/openapi_v2.3-preview.yaml。
- 新增 /agents/* 端点须纳入契约测试套件与冒烟；覆盖率与失败门禁同上。